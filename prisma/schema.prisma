generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// -- User ------------------------------------------------------------------------
model User {
    id                         Int        @id @default(autoincrement())
    email                      String     @unique
    phone                      String?    @unique
    firstName                  String
    lastName                   String?
    middleName                 String?
    dateOfBirth                DateTime?
    avatar                     String?
    company                    String?
    userType                   Int
    city                       String?
    // Settings
    invisibleBeforeDate        DateTime   @default(now())
    canDisturbMeFrom           String?
    canDisturbMeTo             String?
    isReducingLastName         Boolean    @default(false)
    isShowingPatronymic        Boolean    @default(false)
    // Notifications
    emailOnPickOrOffer         Boolean    @default(false)
    notificationOnPickOrOffer  Boolean    @default(false)
    callsOnPickOrOffer         Boolean    @default(false)
    emailOnNewOrder            Boolean    @default(false)
    notificationsOnNewOrder    Boolean    @default(false)
    newOrdersPeriodicity       Int        @default(1)
    emailOnOthers              Boolean    @default(false)
    smsAndCallsOnOthers        Boolean    @default(false)
    timeToNotificationsFrom    String?
    timeToNotificationsTo      String?
    anyTime                    Boolean    @default(false)
    // Communications
    isCustomerAllowedToCall    Boolean    @default(true)
    isCustomerAllowedToChat    Boolean    @default(true)
    isCustomerAllowedToSuggest Boolean    @default(true)
    // Orders
    orders                     Order[]
    responses                  Response[]
    // Meta
    role                       Role       @default(USER)
    createdAt                  DateTime   @default(now())
    updatedAt                  DateTime?
    //
    password                   Password?
    session                    Session[]
}

enum Role {
    USER
    MANAGER
    ADMIN
}

model Password {
    userId Int    @id
    hash   String @unique
    //
    user   User   @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
}

model Session {
    fingerprint  String    @id
    userId       Int
    hostname     String?
    refreshToken String
    createdAt    DateTime  @default(now())
    updatedAt    DateTime?
    //
    user         User      @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
}

model EmailData {
    code  Int
    token String

    @@id([code, token])
}

// -- Category --------------------------------------------------------------------
model Category {
    id            Int           @id @default(autoincrement())
    name          String
    subcategories Subcategory[]
}

// -- Subcategory -----------------------------------------------------------------
model Subcategory {
    id         Int       @id @default(autoincrement())
    categoryId Int?
    name       String
    orders     Order[]
    //
    category   Category? @relation(fields: [categoryId], references: [id], onUpdate: Cascade, onDelete: Cascade)
}

// -- Order -----------------------------------------------------------------------
model Order {
    id             Int          @id @default(autoincrement())
    subcategoryId  Int?
    userId         Int?
    title          String
    description    String?
    location       Locations
    cityId         Int?
    budget         Int
    budgetType     String
    deadline       DateTime
    images         String[]
    phoneIsVisible Boolean      @default(true)
    responses      Response[]
    //
    subcategory    Subcategory? @relation(fields: [subcategoryId], references: [id], onUpdate: Cascade, onDelete: Cascade)
    user           User?        @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
    city           City?        @relation(fields: [cityId], references: [id], onUpdate: Cascade, onDelete: Cascade)
}

enum Locations {
    HERE
    THERE
    REMOTE
}

model Response {
    user    User  @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)
    userId  Int
    order   Order @relation(fields: [orderId], references: [id], onUpdate: Cascade, onDelete: Cascade)
    orderId Int

    @@id([userId, orderId])
}

// -- City ------------------------------------------------------------------------
model City {
    id     Int     @id @default(autoincrement())
    en     String
    ru     String
    orders Order[]
}
